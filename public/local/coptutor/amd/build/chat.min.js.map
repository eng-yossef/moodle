{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["define(['jquery'], function($) {\n\n    return {\n        init: function(courseid) {\n\n            /* ===============================\n               1Ô∏è‚É£ Inject Styles + HTML\n            =============================== */\n\n            // We break long lines into smaller chunks to satisfy Moodle's 132-char limit.\n            const styles = `\n<style>\n#ai-chat-wrapper { position:fixed; bottom:20px; right:20px; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif; }\n#ai-chat-icon { width:60px; height:60px; background:#007bff; border-radius:50%; display:flex; align-items:center;\n    justify-content:center; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,.2); font-size: 24px; }\n#ai-chat-window { display:none; width:400px; height:500px; background:#fff; border-radius:12px;\n    box-shadow:0 8px 24px rgba(0,0,0,.15); flex-direction:column; overflow:hidden; margin-bottom:15px; border: 1px solid #ddd; }\n#ai-chat-header { background:#007bff; color:#fff; padding:15px; font-weight:bold; display:flex;\n    justify-content:space-between; align-items: center; }\n#ai-chat-body { flex:1; padding:15px; overflow-y:auto; background:#f9f9fb; display:flex; flex-direction:column; gap:12px; }\n\n.chat-bubble { padding:12px 16px; border-radius:15px; max-width:85%; font-size:14px; line-height: 1.6; word-wrap: break-word; }\n.user-msg { background:#007bff; color:#fff; align-self:flex-end; border-bottom-right-radius: 2px; }\n.ai-msg { background:#ffffff; color:#333; align-self:flex-start; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }\n\n.ai-msg p { margin: 0 0 10px 0; }\n.ai-msg h3, .ai-msg h4 { margin: 15px 0 5px 0; color: #007bff; font-size: 15px; }\n.ai-msg ul, .ai-msg ol { margin: 5px 0 10px 20px; padding: 0; }\n.ai-msg li { margin-bottom: 5px; }\n.ai-msg hr { border: 0; border-top: 1px solid #eee; margin: 12px 0; }\n.ai-msg a { color: #007bff; text-decoration: underline; }\n\n#ai-chat-footer { padding:10px; border-top:1px solid #eee; display:flex; gap:8px; background:#fff; }\n#ai-chat-input { flex:1; border:1px solid #ddd; border-radius:20px; padding:10px 15px; height:42px; resize:none; outline:none; }\n#ai-chat-send { background:#007bff; color:#fff; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; }\n.typing { font-style:italic; font-size:12px; color:#888; margin-left:10px; }\n</style>`;\n\n            const chatHTML = `\n<div id=\"ai-chat-wrapper\">\n    <div id=\"ai-chat-window\">\n        <div id=\"ai-chat-header\">\n            <span>AI Course Assistant</span>\n            <span id=\"close-chat\" style=\"cursor:pointer; font-size:20px;\">&times;</span>\n        </div>\n        <div id=\"ai-chat-body\"></div>\n        <div id=\"ai-chat-footer\">\n            <textarea id=\"ai-chat-input\" placeholder=\"Ask a question...\"></textarea>\n            <button id=\"ai-chat-send\">‚û§</button>\n        </div>\n    </div>\n    <div id=\"ai-chat-icon\">üí¨</div>\n</div>`;\n\n            $('body').append(styles + chatHTML);\n\n            /* ===============================\n               2Ô∏è‚É£ Helpers\n            =============================== */\n\n            const scrollToBottom = function() {\n                const body = $('#ai-chat-body');\n                body.animate({scrollTop: body[0].scrollHeight}, 300);\n            };\n\n            const renderBubble = function(content, type) {\n                // Using .html() ensures the AI's formatting (bold, lists) renders correctly.\n                return $('<div>').addClass('chat-bubble ' + type).html(content);\n            };\n\n            /* ===============================\n               3Ô∏è‚É£ LOAD HISTORY\n            =============================== */\n\n            let historyLoaded = false;\n\n            const loadHistory = function() {\n                fetch(M.cfg.wwwroot + '/local/coptutor/history.php?courseid=' + courseid)\n                .then(function(res) {\n                    return res.json();\n                })\n                .then(function(history) {\n                    $('#ai-chat-body').empty();\n                    if (!history.length) {\n                        $('#ai-chat-body').append(renderBubble('Hello! How can I help you today?', 'ai-msg'));\n                    } else {\n                        history.forEach(function(item) {\n                            $('#ai-chat-body').append(renderBubble(item.question, 'user-msg'));\n                            $('#ai-chat-body').append(renderBubble(item.answer, 'ai-msg'));\n                        });\n                    }\n                    scrollToBottom();\n                });\n            };\n\n            /* ===============================\n               4Ô∏è‚É£ SEND MESSAGE\n            =============================== */\n\n            const sendMessage = function() {\n                const message = $('#ai-chat-input').val().trim();\n                if (!message) {\n                    return;\n                }\n\n                $('#ai-chat-body').append(renderBubble(message, 'user-msg'));\n                $('#ai-chat-input').val('');\n\n                const loadingId = 'loading-' + Date.now();\n                $('#ai-chat-body').append('<div id=\"' + loadingId + '\" class=\"typing\">AI is thinking...</div>');\n                scrollToBottom();\n\n                fetch(M.cfg.wwwroot + '/local/coptutor/ajax.php', {\n                    method: 'POST',\n                    headers: {'Content-Type': 'application/json'},\n                    body: JSON.stringify({message: message, courseid: courseid})\n                })\n                .then(function(res) {\n                    return res.json();\n                })\n                .then(function(data) {\n                    $('#' + loadingId).remove();\n                    $('#ai-chat-body').append(renderBubble(data.reply, 'ai-msg'));\n                    scrollToBottom();\n                })\n                .catch(function() {\n                    $('#' + loadingId).text('Error: AI offline');\n                });\n            };\n\n            /* ===============================\n               5Ô∏è‚É£ EVENTS\n            =============================== */\n\n            $('#ai-chat-icon').on('click', function() {\n                $('#ai-chat-window').fadeToggle(200).css('display', 'flex');\n                if (!historyLoaded) {\n                    loadHistory();\n                    historyLoaded = true;\n                }\n            });\n\n            $('#close-chat').on('click', function() {\n                $('#ai-chat-window').fadeOut(200);\n            });\n\n            $('#ai-chat-send').on('click', sendMessage);\n\n            $('#ai-chat-input').on('keypress', function(e) {\n                if (e.which === 13 && !e.shiftKey) {\n                    e.preventDefault();\n                    sendMessage();\n                }\n            });\n        }\n    };\n});"],"names":["define","$","init","courseid","append","styles","scrollToBottom","body","animate","scrollTop","scrollHeight","renderBubble","content","type","addClass","html","historyLoaded","sendMessage","message","val","trim","loadingId","Date","now","fetch","M","cfg","wwwroot","method","headers","JSON","stringify","then","res","json","data","remove","reply","catch","text","on","fadeToggle","css","history","empty","length","forEach","item","question","answer","fadeOut","e","which","shiftKey","preventDefault"],"mappings":"AAAAA,6BAAO,CAAC,WAAW,SAASC,SAEjB,CACHC,KAAM,SAASC,UAmDXF,EAAE,QAAQG,OAAOC,w/EAMXC,eAAiB,iBACbC,KAAON,EAAE,iBACfM,KAAKC,QAAQ,CAACC,UAAWF,KAAK,GAAGG,cAAe,MAG9CC,aAAe,SAASC,QAASC,aAE5BZ,EAAE,SAASa,SAAS,eAAiBD,MAAME,KAAKH,cAOvDI,eAAgB,QAyBdC,YAAc,iBACVC,QAAUjB,EAAE,kBAAkBkB,MAAMC,WACrCF,eAILjB,EAAE,iBAAiBG,OAAOO,aAAaO,QAAS,aAChDjB,EAAE,kBAAkBkB,IAAI,UAElBE,UAAY,WAAaC,KAAKC,MACpCtB,EAAE,iBAAiBG,OAAO,YAAciB,UAAY,4CACpDf,iBAEAkB,MAAMC,EAAEC,IAAIC,QAAU,2BAA4B,CAC9CC,OAAQ,OACRC,QAAS,gBAAiB,oBAC1BtB,KAAMuB,KAAKC,UAAU,CAACb,QAASA,QAASf,SAAUA,aAErD6B,MAAK,SAASC,YACJA,IAAIC,UAEdF,MAAK,SAASG,MACXlC,EAAE,IAAMoB,WAAWe,SACnBnC,EAAE,iBAAiBG,OAAOO,aAAawB,KAAKE,MAAO,WACnD/B,oBAEHgC,OAAM,WACHrC,EAAE,IAAMoB,WAAWkB,KAAK,yBAQhCtC,EAAE,iBAAiBuC,GAAG,SAAS,WAC3BvC,EAAE,mBAAmBwC,WAAW,KAAKC,IAAI,UAAW,QAC/C1B,gBA3DLQ,MAAMC,EAAEC,IAAIC,QAAU,wCAA0CxB,UAC/D6B,MAAK,SAASC,YACJA,IAAIC,UAEdF,MAAK,SAASW,SACX1C,EAAE,iBAAiB2C,QACdD,QAAQE,OAGTF,QAAQG,SAAQ,SAASC,MACrB9C,EAAE,iBAAiBG,OAAOO,aAAaoC,KAAKC,SAAU,aACtD/C,EAAE,iBAAiBG,OAAOO,aAAaoC,KAAKE,OAAQ,cAJxDhD,EAAE,iBAAiBG,OAAOO,aAAa,mCAAoC,WAO/EL,oBA+CAU,eAAgB,MAIxBf,EAAE,eAAeuC,GAAG,SAAS,WACzBvC,EAAE,mBAAmBiD,QAAQ,QAGjCjD,EAAE,iBAAiBuC,GAAG,QAASvB,aAE/BhB,EAAE,kBAAkBuC,GAAG,YAAY,SAASW,GACxB,KAAZA,EAAEC,OAAiBD,EAAEE,WACrBF,EAAEG,iBACFrC"}