{"version":3,"file":"community.min.js","sources":["../src/community.js"],"sourcesContent":["/**\n * Global Community AMD module for Moodle 5.1.\n *\n * @module     local_community/community\n * @copyright  2026 Youssef Khaled\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/notification'\n], function($, ModalFactory, ModalEvents, Notification) {\n\n    const Selectors = {\n        container: '#community-app',\n        askBtn: '#ask-question-btn'\n    };\n\n    /**\n     * Render the post list using Bootstrap 5 Card styling.\n     *\n     * @param {Array} posts Array of post objects from the backend.\n     */\n    function renderPosts(posts) {\n        let html = `\n            <div class=\"d-flex justify-content-between align-items-center mb-4\">\n                <h2 class=\"h4 fw-bold text-dark\">Community Discussions</h2>\n                <button id=\"ask-question-btn\" class=\"btn btn-primary rounded-pill px-4 shadow-sm\">\n                    <i class=\"fa fa-plus me-2\"></i>Ask Question\n                </button>\n            </div>\n            <div class=\"row\" id=\"posts-grid\">\n        `;\n\n        if (posts.length === 0) {\n            html += `\n                <div class=\"col-12 text-center py-5\">\n                    <div class=\"alert alert-light border-dashed\">\n                        No discussions yet. Start the conversation!\n                    </div>\n                </div>`;\n        }\n\n        posts.forEach(p => {\n            html += `\n                <div class=\"col-12 mb-3\">\n                    <div class=\"card h-100 border-0 shadow-sm transition\">\n                        <div class=\"card-body d-flex align-items-center\">\n                            <div class=\"vote-count text-center me-4 border-end pe-4\" style=\"min-width: 80px;\">\n                                <span class=\"d-block h4 mb-0 fw-bold text-primary\">${p.votes}</span>\n                                <small class=\"text-muted text-uppercase small fw-semibold\">Votes</small>\n                            </div>\n                            <div class=\"post-content\">\n                                <h5 class=\"card-title mb-1\">\n                                    <a href=\"${M.cfg.wwwroot}/local/community/pages/post.php?id=${p.id}\"\n                                       class=\"text-decoration-none text-dark stretched-link\">\n                                        ${p.title}\n                                    </a>\n                                </h5>\n                                <p class=\"card-text small text-muted mb-0\">\n                                    <span class=\"me-2\">\n                                        <i class=\"fa fa-user-circle me-1\"></i>${p.firstname} ${p.lastname}\n                                    </span>\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n        });\n\n        html += `</div>`;\n        $(Selectors.container).html(html);\n    }\n\n    /**\n     * Fetch posts from the server.\n     */\n    function loadPosts() {\n        fetch(`${M.cfg.wwwroot}/local/community/ajax/get_posts.php`)\n            .then(res => res.json())\n            .then(res => {\n                renderPosts(res);\n            }).catch(Notification.exception);\n    }\n\n    /**\n     * Create and initialize the Modal for asking questions.\n     */\nfunction initModal() {\n    ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: 'Ask a New Question',\n        body: `\n            <div class=\"p-2\">\n                <div class=\"mb-3\">\n                    <label for=\"post-title\" class=\"form-label fw-bold\">Title</label>\n                    <input type=\"text\" class=\"form-control shadow-none\" id=\"post-title\"\n                           placeholder=\"e.g. How do I use the new Moodle 5.1 Gradebook?\">\n                    <div id=\"similar-questions\" class=\"mt-2\"></div>\n                </div>\n                <div class=\"mb-3\">\n                    <label for=\"post-content\" class=\"form-label fw-bold\">Details</label>\n                    <textarea class=\"form-control shadow-none\" id=\"post-content\" rows=\"5\"\n                              placeholder=\"Explain your question in detail...\"></textarea>\n                </div>\n            </div>\n        `,\n        buttons: {save: 'Post Question'}\n    }).then(modal => {\n        $(document).on('click', Selectors.askBtn, e => {\n            e.preventDefault();\n            modal.show();\n        });\n\n        // --- Similar Questions Feature ---\n        modal.getRoot().on('input', '#post-title', function() {\n            const title = $(this).val();\n            if (title.length < 3) {\n                $('#similar-questions').empty();\n                return;\n            }\n\n            fetch(M.cfg.wwwroot + '/local/community/ajax/similar.php?q=' + encodeURIComponent(title))\n                .then(res => res.json())\n                .then(function(data) {\n                    if (!data.length) {\n                        $('#similar-questions').html('<small>No similar questions found.</small>');\n                        return;\n                    }\n                    let html = '<h6>ðŸ¤– AI Similar Questions</h6><ul class=\"list-unstyled\">';\n                    data.forEach(function(item) {\n                        html += `<li>\n                        <a href=\"${M.cfg.wwwroot}/local/community/pages/post.php?id=${item.id}\">${item.title}</a>\n                        </li>`;\n                    });\n                    html += '</ul>';\n                    $('#similar-questions').html(html);\n                });\n        });\n        // ---------------------------------\n\n        modal.getRoot().on(ModalEvents.save, e => {\n            const title = $('#post-title').val();\n            const content = $('#post-content').val();\n\n            if (!title || !content) {\n                e.preventDefault();\n                Notification.addNotification({\n                    message: 'Both fields are required',\n                    type: 'error'\n                });\n                return;\n            }\n\n            submitPost(title, content, modal);\n        });\n    });\n}\n\n\n    /**\n     * Submit the post data to the server.\n     *\n     * @param {string} title The title of the post.\n     * @param {string} content The body of the post.\n     * @param {Object} modal The modal instance.\n     */\n    function submitPost(title, content, modal) {\n        fetch(`${M.cfg.wwwroot}/local/community/ajax/create_post.php`, {\n            method: 'POST',\n            body: JSON.stringify({title, content, posttype: 'question'})\n        }).then(() => {\n            modal.hide();\n            loadPosts();\n            Notification.addNotification({\n                message: 'Question posted!',\n                type: 'success'\n            });\n        });\n    }\n\n    return {\n        init: () => {\n            loadPosts();\n            initModal();\n        }\n    };\n});"],"names":["define","$","ModalFactory","ModalEvents","Notification","Selectors","loadPosts","fetch","M","cfg","wwwroot","then","res","json","posts","html","length","forEach","p","votes","id","title","firstname","lastname","renderPosts","catch","exception","initModal","create","type","types","SAVE_CANCEL","body","buttons","save","modal","document","on","e","preventDefault","show","getRoot","this","val","empty","encodeURIComponent","data","item","content","addNotification","message","method","JSON","stringify","posttype","hide","submitPost","init"],"mappings":";;;;;;;AAQAA,mCAAO,CACH,SACA,qBACA,oBACA,sBACD,SAASC,EAAGC,aAAcC,YAAaC,oBAEhCC,oBACS,iBADTA,iBAEM,6BA+DHC,YACLC,gBAASC,EAAEC,IAAIC,gDACVC,MAAKC,KAAOA,IAAIC,SAChBF,MAAKC,gBA1DOE,WACbC,obAUiB,IAAjBD,MAAME,SACND,6PAQJD,MAAMG,SAAQC,IACVH,uZAKyEG,EAAEC,2UAKxCX,EAAEC,IAAIC,sDAA6CQ,EAAEE,wJAE1DF,EAAEG,wTAKoCH,EAAEI,sBAAaJ,EAAEK,yOAUzFR,eACAd,EAAEI,qBAAqBU,KAAKA,MAUpBS,CAAYZ,QACba,MAAMrB,aAAasB,oBAMzBC,YACLzB,aAAa0B,OAAO,CAChBC,KAAM3B,aAAa4B,MAAMC,YACzBV,MAAO,qBACPW,6xBAeAC,QAAS,CAACC,KAAM,mBACjBvB,MAAKwB,QACJlC,EAAEmC,UAAUC,GAAG,QAAShC,kBAAkBiC,IACtCA,EAAEC,iBACFJ,MAAMK,UAIVL,MAAMM,UAAUJ,GAAG,QAAS,eAAe,iBACjChB,MAAQpB,EAAEyC,MAAMC,MAClBtB,MAAML,OAAS,EACff,EAAE,sBAAsB2C,QAI5BrC,MAAMC,EAAEC,IAAIC,QAAU,uCAAyCmC,mBAAmBxB,QAC7EV,MAAKC,KAAOA,IAAIC,SAChBF,MAAK,SAASmC,UACNA,KAAK9B,mBACNf,EAAE,sBAAsBc,KAAK,kDAG7BA,KAAO,6DACX+B,KAAK7B,SAAQ,SAAS8B,MAClBhC,uDACWP,EAAEC,IAAIC,sDAA6CqC,KAAK3B,gBAAO2B,KAAK1B,gDAGnFN,MAAQ,QACRd,EAAE,sBAAsBc,KAAKA,YAKzCoB,MAAMM,UAAUJ,GAAGlC,YAAY+B,MAAMI,UAC3BjB,MAAQpB,EAAE,eAAe0C,MACzBK,QAAU/C,EAAE,iBAAiB0C,UAE9BtB,QAAU2B,eACXV,EAAEC,sBACFnC,aAAa6C,gBAAgB,CACzBC,QAAS,2BACTrB,KAAM,oBAkBFR,MAAO2B,QAASb,OAChC5B,gBAASC,EAAEC,IAAIC,iDAAgD,CAC3DyC,OAAQ,OACRnB,KAAMoB,KAAKC,UAAU,CAAChC,MAAAA,MAAO2B,QAAAA,QAASM,SAAU,eACjD3C,MAAK,KACJwB,MAAMoB,OACNjD,YACAF,aAAa6C,gBAAgB,CACzBC,QAAS,mBACTrB,KAAM,eAtBV2B,CAAWnC,MAAO2B,QAASb,mBA2B5B,CACHsB,KAAM,KACFnD,YACAqB"}