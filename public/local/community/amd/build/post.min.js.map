{"version":3,"file":"post.min.js","sources":["../src/post.js"],"sourcesContent":["/**\n * Post details page logic for Moodle 5.1.\n *\n * @module      local_community/post\n * @copyright   2026 Youssef Khaled\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification'], function($, Notification) {\n\n    let currentPostId = null;\n    const SELECTORS = {\n        container: '#post-data-container',\n        answerInput: '#answercontent',\n        submitBtn: '#addanswer'\n    };\n\n    /**\n     * Convert a timestamp to a human-readable \"time ago\" format.\n     *\n     * @param {Number} timestamp The timestamp in seconds.\n     * @returns {String} A string like \"5 minutes ago\".\n     */\n    function timeAgo(timestamp) {\n    const now = new Date();\n    const time = new Date(timestamp * 1000); // PHP timestamp in seconds\n    const diff = Math.floor((now - time) / 1000); // difference in seconds\n\n    if (diff < 60){ return `${diff} seconds ago`;}\n    if (diff < 3600) {return `${Math.floor(diff / 60)} minutes ago` ;}\n    if (diff < 86400) {return `${Math.floor(diff / 3600)} hours ago`;}\n    if (diff < 2592000) { return `${Math.floor(diff / 86400)} days ago`;}\n\n    return time.toLocaleDateString(); // fallback: full date\n}\n\n    /**\n     * Render the post details and answers into the container.\n     *\n     * @param {Object} data The post and answers data.\n     */\n    function render(data) {\n        const {post, answers} = data;\n\n        // Post Header and Content.\n        let html = `\n            <div class=\"post-container mb-5 animate__animated animate__fadeIn\">\n                <div class=\"border-bottom pb-3 mb-4\">\n                    <h1 class=\"display-6 fw-bold text-dark mb-2\">${post.title}</h1>\n                    <div class=\"d-flex align-items-center flex-wrap gap-3 text-muted small\">\n                    <div class=\"me-3\">\n        <i class=\"fa fa-calendar-o me-1\"></i> Asked ${timeAgo(post.timecreated)}\n    </div>\n                        <div><i class=\"fa fa-eye me-1\"></i> Viewed ${post.views || 0} times</div>\n                        <div class=\"badge bg-light text-dark border\">\n                            <i class=\"fa fa-star text-warning me-1\"></i>${post.votes} Score\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"row\">\n                    <div class=\"col-12 mt-2\">\n                        <div class=\"post-body fs-5 text-dark mb-4\">${post.content}</div>\n                        <div class=\"d-flex justify-content-end\">\n                            <div class=\"user-info-card p-3 rounded bg-light border-start border-primary border-4\"\n                                 style=\"min-width: 180px;\">\n                                <span class=\"text-muted d-block small mb-2\">Asked by</span>\n                                <div class=\"author-info\">\n                                    <div class=\"fw-bold text-primary mb-1\">\n                                        ${post.firstname} ${post.lastname}\n                                    </div>\n                                    <div class=\"small text-muted mb-1\">\n                                        <strong>${post.reputation}</strong> reputation\n                                    </div>\n                                    <div class=\"d-flex flex-wrap gap-1\">\n                                        ${post.badges.map(b => `\n                                            <span class=\"badge bg-secondary\" style=\"font-size: 0.7rem;\">\n                                                ${b.name}\n                                            </span>`).join('')}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"answers-header d-flex justify-content-between align-items-center mb-4\">\n                <h4 class=\"fw-bold mb-0\">${answers.length} Answers</h4>\n                <div class=\"dropdown\">\n                    <button class=\"btn btn-sm btn-outline-secondary dropdown-toggle\" type=\"button\">\n                        Sort by: Votes\n                    </button>\n                </div>\n            </div>`;\n\n        // Answers List.\n        answers.forEach(a => {\n            const upActive = a.uservote === 1 ? 'text-success' : 'text-muted';\n            const downActive = a.uservote === -1 ? 'text-danger' : 'text-muted';\n            const upDisabled = a.uservote === 1 ? 'disabled' : '';\n            const downDisabled = a.uservote === -1 ? 'disabled' : '';\n\n            html += `\n                <div class=\"answer-card card border-0 shadow-sm mb-4\">\n                    <div class=\"card-body p-4\">\n                        <div class=\"d-flex\">\n                            <div class=\"d-flex flex-column align-items-center me-4\">\n                                <button class=\"btn btn-link p-0 vote-answer ${upActive}\"\n                                        data-id=\"${a.id}\" data-value=\"1\" ${upDisabled} title=\"Upvote\">\n                                    <i class=\"fa fa-chevron-up fa-2x\"></i>\n                                </button>\n                                <span class=\"fw-bold fs-4 my-1\">${a.votes}</span>\n                                <button class=\"btn btn-link p-0 vote-answer ${downActive}\"\n                                        data-id=\"${a.id}\" data-value=\"-1\" ${downDisabled} title=\"Downvote\">\n                                    <i class=\"fa fa-chevron-down fa-2x\"></i>\n                                </button>\n                            </div>\n\n                            <div class=\"flex-grow-1\">\n                                <div class=\"answer-text mb-4 text-dark\" style=\"line-height: 1.6;\">${a.content}</div>\n                                <div class=\"d-flex justify-content-between align-items-center mt-3\">\n                                    <div class=\"actions\">\n                                        ${a.can_delete ? `\n                                            <button class=\"btn btn-link btn-sm text-danger p-0 delete-answer\" data-id=\"${a.id}\">\n                                                <i class=\"fa fa-trash me-1\"></i>Delete\n                                            </button>` : ''}\n                                    </div>\n                                    <div class=\"user-meta small p-2 rounded bg-light border\">\n                                        <span class=\"text-muted\">answered by</span>\n                                        <span class=\"fw-bold text-dark\">${a.firstname} â€¢ ${timeAgo(a.timecreated)}</span>\n                                        <span class=\"text-primary mx-1\">${a.reputation}</span>\n                                        ${a.badges.map(b =>`<span class=\"badge bg-info text-white ms-1\">${b.name}</span>`).join('')}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>`;\n        });\n\n        $(SELECTORS.container).html(html);\n    }\n\n    /**\n     * Refresh post data with a loading overlay.\n     */\n    async function loadPost() {\n        const $container = $(SELECTORS.container);\n        $container.css('opacity', '0.5');\n\n        try {\n            const response = await fetch(`${M.cfg.wwwroot}/local/community/ajax/get_post.php?id=${currentPostId}`);\n            const data = await response.json();\n            render(data);\n        } catch (error) {\n            Notification.exception(error);\n        } finally {\n            $container.css('opacity', '1');\n        }\n    }\n\n    /**\n     * Initialize the post page logic.\n     *\n     * @param {Number} postid The post ID.\n     */\n    function init(postid) {\n        currentPostId = postid;\n        loadPost();\n\n        $(document).on('click', '.vote-answer', async function(e) {\n            e.preventDefault();\n            const btn = $(this);\n            const answerId = btn.data('id');\n            const value = btn.data('value');\n\n            const container = btn.closest('.d-flex.flex-column');\n            container.find('.vote-answer').prop('disabled', true).addClass('opacity-50');\n\n            try {\n                await fetch(`${M.cfg.wwwroot}/local/community/ajax/vote.php`, {\n                    method: 'POST',\n                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n                    body: new URLSearchParams({\n                        answerid: answerId,\n                        value: value,\n                        postid: currentPostId,\n                        sesskey: M.cfg.sesskey\n                    })\n                });\n                await loadPost();\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        $(document).on('click', SELECTORS.submitBtn, async function(e) {\n            e.preventDefault();\n            const $btn = $(this);\n            const content = $(SELECTORS.answerInput).val().trim();\n\n            if (!content) {\n                Notification.addNotification({\n                    message: 'Please enter a response before posting.',\n                    type: 'error'\n                });\n                return;\n            }\n\n            $btn.prop('disabled', true).html('<i class=\"fa fa-circle-o-notch fa-spin\"></i> Posting...');\n\n            try {\n                await fetch(`${M.cfg.wwwroot}/local/community/ajax/create_answer.php`, {\n                    method: 'POST',\n                    headers: {'Content-Type': 'application/json'},\n                    body: JSON.stringify({postid: currentPostId, content: content})\n                });\n                $(SELECTORS.answerInput).val('');\n                await loadPost();\n            } catch (error) {\n                Notification.exception(error);\n            } finally {\n                $btn.html('Post Your Answer');\n            }\n        });\n\n        $(document).on('click', '.delete-answer', function(e) {\n            e.preventDefault();\n            const id = $(this).data('id');\n\n            Notification.confirm(\n                'Confirm Deletion',\n                'This action cannot be undone. Are you sure you want to delete this answer?',\n                'Delete',\n                'Cancel',\n                async () => {\n                    try {\n                        await fetch(`${M.cfg.wwwroot}/local/community/ajax/delete_answer.php`, {\n                            method: 'POST',\n                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n                            body: new URLSearchParams({\n                                answerid: id,\n                                sesskey: M.cfg.sesskey\n                            })\n                        });\n                        await loadPost();\n                    } catch (error) {\n                        Notification.exception(error);\n                    }\n                }\n            );\n        });\n\n        $(document).on('input', SELECTORS.answerInput, function() {\n            const hasContent = $(this).val().trim().length > 0;\n            $(SELECTORS.submitBtn).prop('disabled', !hasContent);\n        });\n    }\n\n    return {init: init};\n});"],"names":["define","$","Notification","currentPostId","SELECTORS","timeAgo","timestamp","now","Date","time","diff","Math","floor","toLocaleDateString","loadPost","$container","css","response","fetch","M","cfg","wwwroot","data","post","answers","html","title","timecreated","views","votes","content","firstname","lastname","reputation","badges","map","b","name","join","length","forEach","a","upActive","uservote","downActive","upDisabled","downDisabled","id","can_delete","render","json","error","exception","init","postid","document","on","async","e","preventDefault","btn","this","answerId","value","closest","find","prop","addClass","method","headers","body","URLSearchParams","answerid","sesskey","$btn","val","trim","JSON","stringify","addNotification","message","type","confirm","hasContent"],"mappings":"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"}